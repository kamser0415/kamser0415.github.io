---
layout: single
title: TIL) ν•„ν„°μ™€ μΈν„°μ…‰ν„°: κ³µν†µ κ΄€μ‹¬μ‚¬ μ²λ¦¬
categories: TIL
tag: [Today I Learned]
toc: true
toc_sticky: true
author_profile: false
sidebar:
    nav: "docs"
search: true
sidebar:
    nav: "counts"
typora-root-url: ../
---

## π“ 2025-04-05 TIL

## μ£Όμ 
- ν•„ν„°μ™€ μΈν„°μ…‰ν„°μ ν•™μµ λ©μ 
- ν•„ν„°μ™€ μΈν„°μ…‰ν„° λΉ„κµ

## ν•™μµ λ©μ 

### μ›Ή κ³µν†µ κ΄€μ‹¬μ‚¬

ν•„ν„°μ™€ μΈν„°μ…‰ν„°λ” μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ μΈμ¦, μΈκ°€, μΈμ½”λ”©, λ΅κΉ…, λ³΄μ• λ“± μ—¬λ¬ λ΅μ§μ΄ κ³µν†µμΌλ΅ μ μ©λμ–΄μ•Ό ν•λ” λ¶€λ¶„(**κ³µν†µ κ΄€μ‹¬μ‚¬**)λ¥Ό μ²λ¦¬ν•©λ‹λ‹¤.

+ μ»¨νΈλ΅¤λ¬λ§λ‹¤ μ΄λ° λ΅μ§μ„ μ§μ ‘ κµ¬ν„ν•λ©΄ μ½”λ“ μ¤‘λ³µμ΄ λ°μƒν•κ³ , μμ •μ‹ λ¨λ“  μ»¨νΈλ΅¤λ¬λ¥Ό λ³€κ²½ν•΄μ•Όν•λ” μ μ§€λ³΄μ λ¬Έμ κ°€ μƒκΉλ‹λ‹¤.

+ μ¤ν”„λ§μ—μ„λ” μ¤ν”„λ§ AOPλ¥Ό ν™μ©ν•  μ μμ§€λ§, μ›Ή κ΄€λ ¨ κ³µν†µ κ΄€μ‹¬μ‚¬(HTTP ν—¤λ”, URL μ •λ³΄ λ° λ¶„κΈ° μ²λ¦¬κ°€ ν•„μ”ν• κ²½μ°)λ” μ„λΈ”λ¦Ώ ν•„ν„°μ™€ μ¤ν”„λ§ μΈν„°μ…‰ν„°κ°€ μ ν•©ν•©λ‹λ‹¤.

  > AOPλ΅ κµ¬ν„ν•  μ μμ§€λ§ λ™λ£ κ°λ°μκ°€ μ›Ή κ³µν†µ κ΄€μ‹¬μ‚¬μ΄λ©° κµ¬μ΅° μ„μΉλ¥Ό μ• μ μλ” ν•„ν„°μ™€ μΈν„°μ…‰ν„°λ¥Ό μ‚¬μ©ν•λ” κ²ƒμ΄ ν€ ν”„λ΅μ νΈμ— λ” μ ν•©ν•λ‹¤κ³  μƒκ°λ„ λ“­λ‹λ‹¤.

+ `HttpServletRequest`μ™€ `HttpServletReponse`λ¥Ό μ κ³µν•μ—¬ μ›Ή μ”μ²­/μ‘λ‹µμ„ μ§μ ‘ λ‹¤λ£° μ μμµλ‹λ‹¤.

### κ³µν†µ κ΄€μ‹¬μ‚¬κ°€ μ™ ν•„μ”ν• κΉ

1. μ½”λ“ μ¤‘λ³µ μµμ†ν™”

   μΈμ¦, μΈκ°€, μΈμ½”λ”©, λ΅κΉ…λ“± κ³µν†µμΌλ΅ ν•„μ”ν• κΈ°λ¥μ„ κ° μ»¨νΈλ΅¤λ¬μ— μ§μ ‘ κµ¬ν„ν•λ©΄ μ½”λ“ μ¤‘λ³µμ΄ λ°μƒν•κ³  μ μ§€λ³΄μκ°€ μ–΄λ ¤μ›μ§‘λ‹λ‹¤.

   κ°λ°μκ°€ μ‹¤μλ΅ λ¨λ‘ μμ •ν•μ§€ λ»ν•  κ²½μ° λ¬Έμ κ°€ λ°μƒν•  μ μμΌλ©° μ°ΎκΈ°λ„ μ–΄λ ¤μ› μ§‘λ‹λ‹¤. κ·Έλ¬λ©΄μ„ μ¤‘λ³µλ μ½”λ“λΌλ¦¬ λ²„μ „μ΄ μƒκΈ°κΈ°λ„ ν•©λ‹λ‹¤.

2. κ΄€μ‹¬μ‚¬μ λ¶„λ¦¬

   μ• ν”λ¦¬μΌ€μ΄μ…μ λΉ„μ¦λ‹μ¤ λ΅μ§κ³Ό μ›Ή μ”μ²­ μ „μ²λ¦¬/ν›„μ²λ¦¬ λ΅μ§μ„ λ¶„λ¦¬ν•μ—¬, μ½”λ“ κ°€λ…μ„±κ³Ό μ μ§€λ³΄μν•κΈ° νΈν•΄μ§‘λ‹λ‹¤.

3. μ¬μ‚¬μ©μ„± λ° μΌκ΄€μ„±

   ν• κ³³μ—μ„ κ³µν†µ κ΄€μ‹¬μ‚¬λ¥Ό μ²λ¦¬ν•λ©΄, μ „μ²΄ μ• ν”λ¦¬μΌ€μ΄μ…μ—μ„ μΌκ΄€λ λ³΄μ• λ° μ²λ¦¬λ¥Ό ν•  μ μμµλ‹λ‹¤.

## λ³Έλ΅ 

μ›Ή μ”μ²­ νλ¦„μ„ κ°„λ‹¨ν• λ‹¤μ΄μ–΄ κ·Έλ¨μΌλ΅ κ·Έλ ¤λ³΄λ©΄

```
 [WAS]
   β”‚
   β–Ό
[ν•„ν„° μ²΄μΈ]          β† μ„λΈ”λ¦Ώ μ»¨ν…μ΄λ„ λ λ²¨ (μ¤ν”„λ§ μ™Έ μ”μ²­ ν¬ν•¨)
   β”‚
   β–Ό
[μ„λΈ”λ¦Ώ (DispatcherServlet)]
   β”‚
   β–Ό
[μΈν„°μ…‰ν„° μ²΄μΈ]      β† μ¤ν”„λ§ MVC λ‚΄λ¶€ (preHandle β†’ μ»¨νΈλ΅¤λ¬ β†’ postHandle β†’ afterCompletion)
   β”‚
   β–Ό
[μ»¨νΈλ΅¤λ¬]
   β”‚
   β–Ό
 [μ‘λ‹µ]
```

+ ν•„ν„° : WASμ μ„λΈ”λ¦Ώ μ‚¬μ΄μ— λ™μ‘ν•©λ‹λ‹¤. μ •μ  λ¦¬μ†μ¤ μ”μ²­μ΄λ‚ μ¤ν”„λ§ μ™Έ μ”μ²­κΉμ§€ ν¬ν•¨ν• μ „μ—­ μ μ–΄ κ°€λ¥ν•©λ‹λ‹¤.
+ μΈν„°μ…‰ν„° : μ¤ν”„λ§ MVCμ `DispatcherServlet` λ‚΄λ¶€μ—μ„ μ»¨νΈλ΅¤λ¬ νΈμ¶ μ „ν›„λ΅ λ™μ‘ν•λ©°, μ¤ν”„λ§ μ»¨νƒμ¤νΈμ— μν•΄ κ΄€λ¦¬λ©λ‹λ‹¤.

### ν•„ν„°(Servlet Filter)

**ν•„ν„°λ” μ„λΈ”λ¦Ώ μ „/ν›„μ²λ¦¬ μ»΄ν¬λ„νΈλ‹¤.**

**νΉμ§• λ° μ¥μ **

#### μ „μ²΄ μ”μ²­ μ μ–΄

μ„λΈ”λ¦Ώ μ»¨ν…μ΄λ„ λ λ²¨μ—μ„ μ‹¤ν–‰λμ–΄, μ •μ  λ¦¬μ†μ¤ μ”μ²­κΉμ§€ ν¬ν•¨ν• λ¨λ“  HTTP μ”μ²­μ„ μ μ–΄ν•  μ μμµλ‹λ‹¤.

`chan.doFilter()`λ¥Ό νΈμ¶ν•μ§€ μ•κ³ , `return;`ν•λ©΄ μ”μ²­ νλ¦„μ„ **μ—¬κΈ°μ„** μ™„μ „ν μΆ…λ£ν•  μ μμµλ‹λ‹¤.

#### λ™μ  μ²΄μΈ κµ¬μ„±

URL ν¨ν„΄, HTTP λ©”μ„λ“, λ³΄μ• μ„¤μ • λ“±μ— λ”°λΌ μ”μ²­λ³„λ΅ λ™μ μΈ ν•„ν„° μ²΄μΈμ„ κµ¬μ„±ν•  μ μμµλ‹λ‹¤.

```java
// μ΄κΈ°ν™”: ν•„ν„° κµ¬μ„± μ •μ
@PostConstruct
public void initialize() {
    // API μ”μ²­μ— λ€ν• ν•„ν„° κµ¬μ„±
    addFilterConfig(new FilterConfig()
            .withUrlPattern("/api/.*")
            .withHttpMethod("GET", "POST")
            .withFilters(loggingFilter, apiKeyValidationFilter, rateLimitFilter)
            .withOrder(1));

    // κ΄€λ¦¬μ μμ—­μ— λ€ν• ν•„ν„° κµ¬μ„±
    addFilterConfig(new FilterConfig()
            .withUrlPattern("/admin/.*")
            .withFilters(loggingFilter, securityFilter)
            .withSecurityLevel(SecurityLevel.HIGH)
            .withOrder(2));

    // μ •μ  λ¦¬μ†μ¤μ— λ€ν• ν•„ν„° κµ¬μ„±
    addFilterConfig(new FilterConfig()
            .withUrlPattern("/static/.*")
            .withHttpMethod("GET")
            .withFilters(compressionFilter)
            .withOrder(3));

    // λ¨λ“  μ”μ²­μ— μ μ©λλ” κΈ°λ³Έ ν•„ν„°
    addFilterConfig(new FilterConfig()
            .withUrlPattern("/.*")
            .withFilters(loggingFilter)
            .withOrder(Integer.MAX_VALUE)); // κ°€μ¥ λ§μ§€λ§‰μ— ν‰κ°€
}
```

μλ¥Ό λ“¤μ–΄ `/api/**`μ™€ `/admin/`μ— μ„λ΅ λ‹¤λ¥Έ ν•„ν„° μ²΄μΈ μ μ©κ°€λ¥ν•©λ‹λ‹¤.

#### μ‘λ‹µ μ»¤μ¤ν„°λ§μ΄μ§• λ° μμ™Έ μ²λ¦¬

`doFilter()`λ‚΄μ—μ„ `try-catch`λ΅ μμ™Έλ¥Ό μ΅κ³ , `response.reset()`μ„ ν†µν•΄ μ‘λ‹µμ„ μ¬κµ¬μ„±ν•  μ μμµλ‹λ‹¤.

```java
public class ExceptionHandlingFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        HttpServletResponse res = (HttpServletResponse) response;
        try {
            chain.doFilter(request, response); // μ •μƒ μ²λ¦¬
        } catch (Exception e) {
            res.reset(); // μ‘λ‹µ μ΄κΈ°ν™”
            res.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
            res.setContentType("application/json");
            PrintWriter writer = res.getWriter();
            writer.write("{\"error\": \"Internal Server Error: " + e.getMessage() + "\"}");
            writer.flush();
        }
    }
}
```

λ‹¤λ§, μμ™Έκ°€ μ•„λ‹λΌ `response.sendError()`μΌλ΅ λ§μ¤ν‚Ήμ„ ν–λ‹¤λ©΄ ? 



#### μ¤ν”„λ§ μ»¨ν…μ΄λ„ μ™Έλ¶€μ—μ„ λ™μ‘

ν•„ν„°λ” μ¤ν”„λ§ μ»¨νƒμ¤νΈ μ™Έλ¶€μ—μ„ λ™μ‘ν•μ—¬, μ¤ν”„λ§μ— μΆ…μ†λμ§€ μ•κ³  λ‹¤λ¥Έ ν”„λ μ„μ›ν¬μ—μ„ μ‚¬μ© κ°€λ¥ν•©λ‹λ‹¤

+ μ¤ν”„λ§ μ• ν”λ¦¬μΌ€μ΄μ… μ»¨ν…μ¤νΈ μ΄κΈ°ν™” μ „μ— μ‹¤ν–‰ κ°€λ¥ν•©λ‹λ‹¤.

+ μ¤ν”„λ§ ν”„λ μ„μ›ν¬μ λ‚΄λ¶€ μ²λ¦¬ κ³Όμ •μ„ κ±°μΉμ§€ μ•μµλ‹λ‹¤.

  > μ¤ν”„λ§ ν”„λ μ„μ›ν¬μ λ‚΄λ¶€μ²λ¦¬λ” ν•Έλ“¤λ¬ λ§¤ν•‘, μ–΄λ‘ν„° μ°ΎκΈ°, μ¤ν”„λ§ μ”μ²­ λ° μ‘λ‹µ ν”„λ΅μ„Έμ¤ κ³Όμ •μ„ κ±°μΉμ§€ μ•μµλ‹λ‹¤.

+ μ„λΈ”λ¦Ώ APIλ¥Ό μ§μ ‘ μ‚¬μ©ν•μ—¬ μ”μ²­/μ‘λ‹µ μ²λ¦¬λ¥Ό ν•©λ‹λ‹¤.



### μΈν„°μ…‰ν„°(Spring HandlerInterceptor)

**νΉμ§• λ° μ¥μ **

#### μ¤ν”„λ§ MVC λ‚΄λ¶€ μ²λ¦¬

DispatcherServlet λ‚΄λ¶€μ—μ„ λ™μ‘ν•μ—¬, μ»¨νΈλ΅¤λ¬ μ „ ν›„ μ‘λ‹µ ν›„ μ™€ κ°™μ΄ μ„Έλ°€ν• μ²λ¦¬κ°€ κ°€λ¥ν•©λ‹λ‹¤.

#### κ³ μ •λ μ²΄μΈ κµ¬μ„±

`InterceptorRegistry`μ— λ“±λ΅λ μμ„(`@Order`)λ΅ κ³ μ •λ μ²΄μΈ μ‹¤ν–‰ν•©λ‹λ‹¤.

μ”μ²­λ³„ λ™μ  μ²΄μΈ κµ¬μ„±μ€ μ–΄λ ¤μ°λ‚ ν•„μ”ν•λ‹¤λ©΄ μΈν„°μ…‰ν„° λ‚΄μ λ¶„κΈ°λ¬ΈμΌλ΅ μ‹¤ν–‰μ΄ κ°€λ¥ν•©λ‹λ‹¤.

##### 1. μ΅°κ±΄λ¶€ λ΅μ§ μ μ©

```java
@Override
public boolean preHandle(...) {
    if (isApiRequest(request)) {
        // API μ”μ²­ μ „μ© λ΅μ§
    } else if (isAdminRequest(request)) {
        // κ΄€λ¦¬μ μ”μ²­ μ „μ© λ΅μ§
    }
    return true;
}
```

##### 2. μ»¨νƒμ¤νΈ κΈ°λ° μΈν„°μ…‰ν„°

```java
@Autowired
private UserContextHolder contextHolder;

@Override
public boolean preHandle(...) {
    UserContextHolder context = contextHolder.getContext();
    if (context.hasRole("ADMIN")) {
        // κ΄€λ¦¬μμ© λ΅μ§
    }
    return true;
}
```

#### μ ν•λ μ‘λ‹µ μ»¤μ¤ν„°λ§μ΄μ§• λ° μμ™Έ μ²λ¦¬

`preHandle`μ—μ„ `return false;`λ΅ μ”μ²­ μ¤‘λ‹¨ κ°€λ¥ν•μ§€λ§, μ΄ν›„ νλ¦„μ€ **μ¤ν”„λ§ μ»¨ν…μ΄λ„κ°€ λ§λ¬΄λ¦¬ν•©λ‹λ‹¤.**

μ¦‰ μμ™Έμ— λ€ν• μ‘λ‹µμ²λ¦¬λ” μ¤ν”„λ§ MVCμ—μ„ μ²λ¦¬ν•΄μ•Όν•©λ‹λ‹¤.

λ‹¤λ¥Έ λ§λ΅ ν•λ©΄ κ¶ν•μ΄ μ ν•λμ–΄μμ§€λ§ SRPλ¥Ό μ§€ν‚¬ μ μμµλ‹λ‹¤.

`afterCompletion`μ—μ„ μμ™Έ μ²λ¦¬ κ°€λ¥ν•λ‚, μ‘λ‹µμ΄ μ΄λ―Έ μ»¤λ°‹λ κ²½μ° μ¬κµ¬μ„± μ–΄λ µμµλ‹λ‹¤.

#### DI λ° μ¤ν”„λ§ ν†µν•©

μ¤ν”„λ§ λΉμΌλ΅ κ΄€λ¦¬λμ–΄ DI ν™μ© κ°€λ¥ν•λ©°, `HandlerMethod`λ΅ μ»¨νΈλ΅¤λ¬ λ©”μ„λ“ μ •λ³΄(μ: μ–΄λ…Έν…μ΄μ…) ν™μ©μ— μ λ¦¬ν•©λ‹λ‹¤.

```java
public class ExceptionHandlingInterceptor implements HandlerInterceptor {
  @Override
  public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
    if (handler instanceof HandlerMethod) {
        HandlerMethod method = (HandlerMethod) handler;
        if (method.hasMethodAnnotation(AdminOnly.class) 
            && request.getHeader("X-Custom-Auth") == null) {
            response.sendRedirect("/login?redirect="+request.getRequestURI());
            return false;
        }
    }
    return true;
  }
}
```

> μ–΄λ…Έν…μ΄μ…μ„ μ²΄ν¬ν•μ—¬ μ •λ³΄λ΅ ν™μ©ν•  μ μμµλ‹λ‹¤.

### λΉ„κµν‘

| λΉ„κµ ν•­λ©             | ν•„ν„° (λ™μ  μ²΄μΈ κµ¬μ„±)                      | μΈν„°μ…‰ν„° (κ³ μ • μ²΄μΈ)                          |
| --------------------- | ------------------------------------------ | --------------------------------------------- |
| **μ‹¤ν–‰ μ„μΉ**         | WAS β†’ μ„λΈ”λ¦Ώ μ»¨ν…μ΄λ„ (μ¤ν”„λ§ μ™Έλ¶€ ν¬ν•¨)   | μ¤ν”„λ§ MVC λ‚΄λ¶€ (DispatcherServlet μ΄ν›„)      |
| **μ²΄μΈ κµ¬μ„±**         | μ”μ²­λ³„ λ™μ  κµ¬μ„± κ°€λ¥                      | κ³ μ •λ μμ„λ΅ λ¨λ“  μΈν„°μ…‰ν„° μν              |
| **μ‘λ‹µ μ»¤μ¤ν„°λ§μ΄μ§•** | response.reset()μΌλ΅ μμ λ΅­κ² μ¬κµ¬μ„±       | λ·° λ λ”λ§ ν›„ μμ • μ–΄λ ¤μ›€                      |
| **μμ™Έ μ²λ¦¬**         | μ¦‰μ‹ μ΅μ•„ μ²λ¦¬ λ° λ¶„κΈ° κ°€λ¥                | afterCompletion λλ” @ControllerAdviceλ΅ μ²λ¦¬ |
| **μ¤ν”„λ§ μμ΅΄μ„±**     | μ¤ν”„λ§ μ™Έλ¶€μ—μ„ λ…λ¦½μ                      | μ¤ν”„λ§ μ»¨ν…μ¤νΈμ— μμ΅΄, DI μ©μ΄               |
| **ν…μ¤νΈ μ©μ΄μ„±**     | λ¨ν‚Ή ν™κ²½ κµ¬μ„± λ³µμ΅                        | MockMvcλ΅ ν†µν•© ν…μ¤νΈ μ‰¬μ›€                    |
| **μμ™Έλ°μƒμ‹**        | μ„λΈ”λ¦Ώ μ»¨ν…μ΄λ„μ—μ„ μμ™Έμ²λ¦¬               | μ¤ν”„λ§ μ»¨ν…μ΄λ„μ—μ„ μμ™Έ μ²λ¦¬                 |
| **μ‚¬μ© λ©μ **         | ν† ν°μ΄λ‚ μΈμ½”λ”© λ“± HTTP λ λ²¨μ κ³µν†µ κ΄€μ‹¬μ‚¬ | λΉ„μ¦λ‹μ¤ λ λ²¨μ—μ„ μΈμ¦, μΈκ°€ λ“± κ³µν†µ κ΄€μ‹¬μ‚¬   |
| **DispatcherType**    | λ‹¤μ–‘ν• νƒ€μ…μ— λ™μ‘ν•  μ μμµλ‹λ‹¤.          | μ£Όλ΅ REQUESTμ— λ€ν•΄ λ™μ‘ν•©λ‹λ‹¤.               |

