---
layout: single
title: TIL) í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ì„œ
categories: TIL
tag: [Today I Learned]
toc: true
toc_sticky: true
author_profile: false
sidebar:
    nav: "docs"
search: true
sidebar:
    nav: "counts"
typora-root-url: ../
---

## ğŸ“Œ 2025-03-27 TIL

## 1. ì˜¤ëŠ˜ì˜ í•™ìŠµ ì£¼ì œ
- ëª¨í‚¹ê³¼ íŠ¸ëœì­ì…˜ì˜ ê´€ê³„

## 2. í•™ìŠµ ë‚´ìš©

ì €ëŠ” `@SpyBean` ê³¼ `@Transactional`ì˜ ìˆœì„œë¥¼ ì˜ëª»ì•Œì•˜ìŠµë‹ˆë‹¤.

Junitì€ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ë¡œ, @Test ê°™ì€ ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ ë©”ì„œë“œë¥¼ ì‹¤í–‰í•˜ë©°, Mockito ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ í†µí•©í•´ ëª¨ì˜ ê°ì²´ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ í™œìš©í•œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ì„œëŠ” @SpringBootTestì— ì„¤ì • í´ë˜ìŠ¤(ê¸°ë³¸ê°’: xxxApplication.class)ì™€ í´ë˜ìŠ¤ ì •ë³´ë¥¼ ì œê³µí•´ ì»¨í…Œì´ë„ˆë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.

@SpringBootTestëŠ” ê¸°ë³¸ì ìœ¼ë¡œ xxxApplication.classë¥¼ ì‚¬ìš©í•´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ ì´ˆê¸°í™”í•˜ë©°, ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ë¹ˆì„ ìƒì„±í•˜ê³  ìë™ ë“±ë¡ëœ BeanPostProcessorë¥¼ í†µí•´ ì˜ì¡´ì„± ì£¼ì…(@Autowired)ê³¼ AOP(@Transactional)ë¥¼ ì ìš©í•©ë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ë§ˆë‹¤ @SpringBootTestê°€ ìˆìœ¼ë©´ ë§¤ë²ˆ ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ì´ˆê¸°í™”í•˜ë¯€ë¡œ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ ìºì‹±ì„ í†µí•´ ë™ì¼í•œ ì„¤ì •ì„ ì¬ì‚¬ìš©í•˜ë©´ ì´ˆê¸°í™” íšŸìˆ˜ë¥¼ ì¤„ì—¬ í…ŒìŠ¤íŠ¸ ì†ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ ìºì‹±ì€ ìƒì†ìœ¼ë¡œ ê³µí†µ @SpringBootTest ë¶€ëª¨ í´ë˜ìŠ¤ë¥¼ ì •ì˜í•´ ë™ì¼í•œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ê³µìœ í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. í•˜ìœ„ í´ë˜ìŠ¤ì—ì„œ ë‹¤ë¥¸ @MockBeanì´ë‚˜ @SpyBeanì„ ì¶”ê°€í•˜ë©´ ìƒˆ ì»¨í…ìŠ¤íŠ¸ê°€ ìƒì„±ë˜ë‹ˆ, ê³µí†µ ë¹ˆì€ ë¶€ëª¨ í´ë˜ìŠ¤ì— ì •ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

ëª¨í‚¹ì„ ìœ„í•´ ëª¨ì˜ ê°ì²´ë¥¼ ë“±ë¡í•˜ë ¤ë©´, í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ MockitoPostProcessorê°€ ë™ì‘í•©ë‹ˆë‹¤. @SpyBean ê°™ì€ ì–´ë…¸í…Œì´ì…˜ì„ ê°ì§€í•´ postProcessBeforeInitializationì—ì„œ ì›ë³¸ ê°ì²´ë¥¼ ìŠ¤íŒŒì´ë¡œ ê°ì‹¸ê³ , ì´í›„ postProcessAfterInitializationì—ì„œ AOP(ì˜ˆ: íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ)ê°€ ìŠ¤íŒŒì´ë¥¼ ê°ìŒ‰ë‹ˆë‹¤.



ì‹¤ì œë¡œ `@SpyBean`ì´ë‚˜ `@MockBean`ì´ë‚˜ ëª¨ë‘ `@AOP` ê°€ ì ìš©ë©ë‹ˆë‹¤.

íŠ¸ëœì­ì…˜ ì…ì¥ì—ì„œëŠ” ë‚´ê°€ í˜¸ì¶œí•˜ëŠ” ê°ì²´ê°€ ëª¨ì˜ ê°ì²´ ë¹ˆì¸ì§€, ì›ë³¸ ê°ì²´ ë¹ˆì¸ì§€ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì•„ë˜ ì½”ë“œë¥¼ í†µí•´ í™•ì¸í•´ë³´ë©´ íŠ¸ëœì­ì…˜ì´ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
@Test
public void testTransactionManagerActiveWithMocking() {
  Product product = Product.builder().productNumber("001").name("ì•„ë©”ë¦¬ì¹´ë…¸").build();
  Order order = Order.builder().orderStatus(OrderStatus.INIT).build();

  // saveOrder ëª¨í‚¹ + íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ìƒíƒœ í™•ì¸
  doAnswer(invocation -> {
    boolean isTxActive = TransactionSynchronizationManager.isActualTransactionActive();
    System.out.println("íŠ¸ëœì­ì…˜" + isTxActive);
    throw new IOException("");
    // ì—¬ê¸°ì„œ DB ì‘ì—… ì—†ì´ ë‹¨ìˆœ í™•ì¸ë§Œ

  }).when(productService).saveOrder(any(Order.class));

  // ì‹¤í–‰
  productService.saveProductAndOrder(order, product);

  // ê²€ì¦
  verify(productService).saveOrder(order);
}
```

