---
layout: single
title: TIL) í•„í„° ê³µë¶€í•˜ë‹¤ê°€ ì•Œê²Œ ë˜ì—ˆë‹¤.
categories: TIL
tag: [Today I Learned]
toc: true
toc_sticky: true
author_profile: false
sidebar:
    nav: "docs"
search: true
sidebar:
    nav: "counts"
typora-root-url: ../
---

## ğŸ“Œ 2025-04-01 TIL

## 1. ì˜¤ëŠ˜ì˜ í•™ìŠµ ì£¼ì œ
1. í•„í„°ì™€ commit, ê·¸ë¦¬ê³  ì‘ë‹µ ê°ì²´ì™€ ë˜í¼ ê°ì²´

## 2. í•™ìŠµ ë‚´ìš©

```java
@Slf4j
public class LogFilter implements Filter {

	@Override
	public void init(FilterConfig filterConfig) throws ServletException {
		// ì´ˆê¸°í™” ì‘ì—…ì´ ìˆë‹¤ë©´ êµ¬í˜„
	}

	/**
	 * ì‘ë‹µ ë°ì´í„°ë¥¼ ìº¡ì²˜í•˜ê¸° ìœ„í•œ HttpServletResponseWrapper êµ¬í˜„
	 */
	public class CustomResponseWrapper extends HttpServletResponseWrapper {
		private ByteArrayOutputStream capture;
		private ServletOutputStream output;
		private PrintWriter writer;

		public CustomResponseWrapper(HttpServletResponse response) {
			super(response);
			capture = new ByteArrayOutputStream();
		}

		@Override
		public ServletOutputStream getOutputStream() throws IOException {
			if (writer != null) {
				throw new IllegalStateException("getWriter() ì´ë¯¸ í˜¸ì¶œë¨");
			}
			if (output == null) {
				output = new ServletOutputStream() {
					@Override
					public void write(int b) throws IOException {
						capture.write(b);
					}

					@Override
					public boolean isReady() {
						return true;
					}

					@Override
					public void setWriteListener(WriteListener writeListener) {

					}

				};
			}
			return output;
		}

		@Override
		public PrintWriter getWriter() throws IOException {
			if (output != null) {
				throw new IllegalStateException("getOutputStream() ì´ë¯¸ í˜¸ì¶œë¨");
			}
			if (writer == null) {
				writer = new PrintWriter(new OutputStreamWriter(capture, getCharacterEncoding()), true);
			}
			return writer;
		}

		// ìº¡ì²˜ëœ ì‘ë‹µ ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ ë°˜í™˜
		public String getCapturedBody() throws IOException {
			// flush() í˜¸ì¶œí•˜ì—¬ writerë‚˜ outputì˜ ë°ì´í„°ë¥¼ í™•ì‹¤í•˜ê²Œ ë²„í¼ì— ê¸°ë¡
			log.info("getCaptureBody = {}",capture.toString());
			log.info("writer = {}", writer);
			log.info("output = {}", output);
			if (writer != null) {
				writer.flush();
			} else if (output != null) {
				output.flush();
			}
			return new String(capture.toByteArray(), getCharacterEncoding());
		}

		// ìº¡ì²˜ëœ ë°ì´í„°ë¥¼ ì‹¤ì œ ì‘ë‹µì— ë³µì‚¬
		public void copyBodyToResponse() throws IOException {
			byte[] bytes = capture.toByteArray();
			getResponse().setContentLength(bytes.length);
			getResponse().getOutputStream().write(bytes);
		}
	}

	@Override
	public void doFilter(jakarta.servlet.ServletRequest request, jakarta.servlet.ServletResponse response,
		FilterChain chain)
		throws IOException, ServletException {
		HttpServletRequest httpRequest = (HttpServletRequest)request;
		HttpServletResponse httpResponse = (HttpServletResponse)response;

		// ì‘ë‹µ ë°ì´í„°ë¥¼ ìº¡ì²˜í•  ìˆ˜ ìˆë„ë¡ CustomResponseWrapperë¡œ ê°ì‹¼ë‹¤.
		CustomResponseWrapper responseWrapper = new CustomResponseWrapper(httpResponse);

		try {
			// ì²´ì¸ ì§„í–‰: ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì‘ë‹µ ë°ì´í„°ë¥¼ ì‘ì„±í•˜ë©´ CustomResponseWrapperì— ìº¡ì²˜ë¨
			chain.doFilter(request, responseWrapper);

			// ìº¡ì²˜ëœ ì›ë³¸ ì‘ë‹µ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
			String originalBody = responseWrapper.getCapturedBody();
			log.info("ì›ë³¸ ì‘ë‹µ: {}", originalBody);

			// ìˆ˜ì • ì‘ì—… ìˆ˜í–‰: ì˜ˆì œì—ì„œëŠ” ë‹¨ìˆœíˆ [Modified] ë¬¸ìì—´ì„ ì¶”ê°€
			String modifiedBody = originalBody + " [Modified]";
			log.info("ìˆ˜ì •ëœ ì‘ë‹µ: {}", modifiedBody);

			// ìµœì¢… ìˆ˜ì •ëœ ì‘ë‹µì„ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ì†¡
			httpResponse.setContentLength(modifiedBody.getBytes(httpResponse.getCharacterEncoding()).length*2);
			// httpResponse.setContentLength(1);
			log.info("ì»¤ë°‹ì´ ë˜ì—ˆë‚˜ìš”??? [] {}", responseWrapper.isCommitted());
			PrintWriter writer = httpResponse.getWriter();
			writer.write(modifiedBody);
			for (int i = 0; i < 30; i++) {
				writer.println(i);
				log.info("ì»¤ë°‹ì´ ë˜ì—ˆë‚˜ìš”??? [{}] {}",i ,responseWrapper.isCommitted());
				Thread.sleep(100);
			}
		} catch (Exception e) {
			log.error("í•„í„° ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ", e);
			try {
				throw e;
			} catch (InterruptedException ex) {
				throw new RuntimeException(ex);
			}
		}
	}

	@Override
	public void destroy() {
		// ë¦¬ì†ŒìŠ¤ ì •ë¦¬ê°€ í•„ìš”í•˜ë©´ êµ¬í˜„
	}
}

```

ì „ì²´ ì†ŒìŠ¤ ì½”ë“œì…ë‹ˆë‹¤.

ì—¬ê¸°ì„œ í•„í„°ê°€ ì›ë³¸ ê°ì²´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ì´ìœ ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
// ì‘ë‹µ ë°ì´í„°ë¥¼ ìº¡ì²˜í•  ìˆ˜ ìˆë„ë¡ CustomResponseWrapperë¡œ ê°ì‹¼ë‹¤.
CustomResponseWrapper responseWrapper = new CustomResponseWrapper(httpResponse);

try {
  // ì²´ì¸ ì§„í–‰: ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì‘ë‹µ ë°ì´í„°ë¥¼ ì‘ì„±í•˜ë©´ CustomResponseWrapperì— ìº¡ì²˜ë¨
  chain.doFilter(request, responseWrapper);

  // ìº¡ì²˜ëœ ì›ë³¸ ì‘ë‹µ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
  String originalBody = responseWrapper.getCapturedBody();
  log.info("ì›ë³¸ ì‘ë‹µ: {}", originalBody);

  // ìˆ˜ì • ì‘ì—… ìˆ˜í–‰: ì˜ˆì œì—ì„œëŠ” ë‹¨ìˆœíˆ [Modified] ë¬¸ìì—´ì„ ì¶”ê°€
  String modifiedBody = originalBody + " [Modified]";
  log.info("ìˆ˜ì •ëœ ì‘ë‹µ: {}", modifiedBody);

  // ìµœì¢… ìˆ˜ì •ëœ ì‘ë‹µì„ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ì†¡
  httpResponse.setContentLength(modifiedBody.getBytes(httpResponse.getCharacterEncoding()).length*2);
  // httpResponse.setContentLength(1);
  log.info("ì»¤ë°‹ì´ ë˜ì—ˆë‚˜ìš”??? [] {}", responseWrapper.isCommitted());
  PrintWriter writer = httpResponse.getWriter();
  writer.write(modifiedBody);
  for (int i = 0; i < 30; i++) {
    writer.println(i);
    log.info("ì»¤ë°‹ì´ ë˜ì—ˆë‚˜ìš”??? [{}] {}",i ,responseWrapper.isCommitted());
    Thread.sleep(100);
  }
} catch (Exception e) {
  log.error("í•„í„° ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ", e);
  try {
    throw e;
  } catch (InterruptedException ex) {
    throw new RuntimeException(ex);
  }
}
```

1. ì›ë³¸ ê°ì²´ëŠ” í•„í„°ì—ì„œ ì£¼ì…ë°›ì€ ê°ì²´ì´ë‹¤.
2. ë¬¼ë¡  í•„í„°ê°€ ì£¼ì… ë°›ì€ ê°ì²´ë„ ì›ë³¸ ê°ì²´ê°€ ì•„ë‹ ìˆ˜ ìˆë‹¤.
3. ê·¸ëŸ¬ë‚˜ ì›ë³¸ ê°ì²´ì— ëŒ€í•´ì„œ `flush()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ê±´ ë˜í¼ ê°ì²´ë¥¼ ì£¼ì…í•œ í•„í„°ì˜ ì±…ì„ì´ë‹¤.

#### ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ flush í˜¸ì¶œí•´ë„

ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ í˜¸ì¶œí•œ flush()ëŠ” ë˜í¼ ë‚´ë¶€ ë²„í¼ì—ë§Œ ì˜í–¥ì„ ì£¼ê³ , ì‹¤ì œ ì „ì†¡ì€ í•„í„°ê°€ ì›ë³¸ì— ê¸°ë¡í•  ë•Œ ì´ë£¨ì–´ì§„ë‹¤

#### setContentLength ì¤‘ìš”ì„±

**ì¼ë¶€ë¡œ ì›ë³¸ ê°ì²´ì˜ contentlengthë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.**

ê·¸ëŸ¬ë‹ˆ `writer.write(modifiedBody);ë¥¼ í•˜ê³  í”ŒëŸ¬ì‹œë¥¼ í•´ë„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ë¬¼ë¡  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë³´ë‚´ê¸°ëŠ” í•œê²ë‹ˆë‹¤.

ê·¸ëŸ°ë° ì›¹ ë¸Œë¼ìš°ì €ë§ˆë‹¤ ìŠ¤íŠ¸ë¦¼ ì²˜ëŸ¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆìœ¼ë‚˜ ëŒ€ë¶€ë¶„ í´ë¼ì´ì–¸íŠ¸ëŠ” `setContentLength`ì— ë§ì¶°ì¤€ë‹¤ê³  ìƒê°í•˜ë„ ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.



ì—¬ê¸°ì„œ `response`ì˜ ì¸í„°í˜ì´ìŠ¤ê°€ ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.

`Jsp`ì—ì„œë„ ë§ˆì°¬ê°€ì§€ë¡œ í•œë²ˆ í”ŒëŸ¬ì‹œëœ `response`ëŠ” í—¤ë”ì™€ ë°”ë””ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€ëŠ” ê°€ëŠ¥í•©ë‹ˆë‹¤.

ê·¸ë˜ì„œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´¤ìŠµë‹ˆë‹¤.

```java
// ìµœì¢… ìˆ˜ì •ëœ ì‘ë‹µì„ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ì†¡
httpResponse.setContentLength(modifiedBody.getBytes(httpResponse.getCharacterEncoding()).length*2);
// httpResponse.setContentLength(1);
log.info("ì»¤ë°‹ì´ ë˜ì—ˆë‚˜ìš”??? [] {}", responseWrapper.isCommitted());
PrintWriter writer = httpResponse.getWriter();
writer.write(modifiedBody);
writer.flush()
for (int i = 0; i < 30; i++) {
  writer.println(i);
  log.info("ì»¤ë°‹ì´ ë˜ì—ˆë‚˜ìš”??? [{}] {}",i ,responseWrapper.isCommitted());
  Thread.sleep(100);
  writer.flush()
}
```

```java
ì»¤ë°‹ì´ ë˜ì—ˆë‚˜ìš”??? [15] true
```

`flush`ë¥¼ í˜¸ì¶œí•œ ìˆœê°„ë¶€í„° ì»¤ë°‹ë˜ì—ˆë‹¤ê³  í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ `flush`ë¥¼ ë§¤ë²ˆí•´ë„ ê²°êµ­ `setContentLenth`ë¥¼ ë§ì¶”ì§€ ëª»í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ëŠ” ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆë‹¤. ê·¸ê²ƒì´ `TCP/IP`ì…ë‹ˆë‹¤.

ì»¤ë°‹ì„ ì•ˆí•´ë„ `content-length` í—¤ë”ëŠ” ì‘ë‹µ ë³¸ë¬¸ì˜ ì´ ë°”ì´íŠ¸ ìˆ˜ë¥¼ ë§í•´ì¤ë‹ˆë‹¤.

í´ë¼ì´ì–¸íŠ¸ëŠ” ì´ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì½ê³  , ì •í™•í•˜ê²Œ ì´ ê¸¸ì´ë§Œí¼ ë°ì´í„°ê°€ ë„ì°©í•˜ë©´ ì‘ë‹µì´ ì™„ë£Œë˜ì—ˆë‹¤ê³  ìƒê°í•˜ì£ 



ì‹¤ì œë¡œ `Content-Length`ì— ë„ë‹¬í–ˆì„ ë•Œ ì»¨í…Œì´ë„ˆê°€ ì¶œë ¥ ìŠ¤íŠ¸ë¦¼ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

`Content-Length`ì— ë„ë‹¬í•˜ë©´ ìŠ¤íŠ¸ë¦¼ì„ ì •ë¦¬í•˜ê±°ë‚˜ ì»¤ë°‹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë°°ìš´ ì  ìš”ì•½
- ë˜í¼ ê°ì²´ëŠ” ì‘ë‹µì„ ê°€ë¡œì±„ê³  ìˆ˜ì •í•  ìˆ˜ ìˆì§€ë§Œ, ì‹¤ì œ ì „ì†¡ì€ ì›ë³¸ ê°ì²´ì— ì˜ì¡´í•œë‹¤.
- `setContentLength`ëŠ” í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ ë°ì´í„° ì¼ê´€ì„±ì„ ìœ ì§€í•˜ëŠ” í•µì‹¬ì´ë‹¤.
- `flush()`ëŠ” ì»¤ë°‹ì„ ìœ ë°œí•˜ë©°, ì´í›„ í—¤ë” ìˆ˜ì •ì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.



